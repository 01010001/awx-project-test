---
- name: check if restart is required
  hosts: all
  become: true
  gather_facts: false
  tasks:
    - name: run needs-restarting
      ansible.builtin.shell:
        cmd: "needs-restarting -r -s"
      register: needs_restarting
      changed_when: needs_restarting.rc == 1
      failed_when: false

    - name: Report machines that need a restart
      ansible.builtin.debug:
        msg: "RESTART NEEDED on {{ inventory_hostname }}"
      when: needs_restarting.rc == 1


    - name: Build list of hosts needing reboot
      set_stats:
        data:
          needs_reboot_hosts: "{{ (needs_reboot_hosts | default([])) + [inventory_hostname] }}"
      when: needs_restarting.rc == 1
